#!/bin/bash

# 简化版本 - 快速触发检测规则
# 用于测试 EDR 规则: net_connection_win_malware_backconnect_ports.yml

# 目标IP（使用外部IP以确保不是本地IP）
TARGET_IP="8.8.8.8"

# 选择几个代表性的可疑端口
PORTS=(4444 8080 8888 5552 777 666 1443 1515 1777 1817)

echo "开始测试连接到可疑端口..."
echo "目标IP: $TARGET_IP"
echo ""

# 使用 nc (netcat) 连接
if command -v nc &> /dev/null; then
    for port in "${PORTS[@]}"; do
        echo "连接到 $TARGET_IP:$port"
        timeout 1 nc -zv "$TARGET_IP" "$port" 2>&1 | head -1
        sleep 0.3
    done
# 使用 telnet 连接
elif command -v telnet &> /dev/null; then
    for port in "${PORTS[@]}"; do
        echo "连接到 $TARGET_IP:$port"
        timeout 1 telnet "$TARGET_IP" "$port" 2>&1 | head -1
        sleep 0.3
    done
# 使用 Python 连接
elif command -v python3 &> /dev/null; then
    for port in "${PORTS[@]}"; do
        echo "连接到 $TARGET_IP:$port"
        python3 -c "
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.settimeout(0.5)
try:
    s.connect(('$TARGET_IP', $port))
    print('连接成功')
except:
    pass
s.close()
" 2>/dev/null
        sleep 0.3
    done
# 使用 bash 内置 /dev/tcp
else
    for port in "${PORTS[@]}"; do
        echo "连接到 $TARGET_IP:$port"
        timeout 1 bash -c "echo > /dev/tcp/$TARGET_IP/$port" 2>/dev/null
        sleep 0.3
    done
fi

echo ""
echo "测试完成！请检查 EDR 系统日志。"


